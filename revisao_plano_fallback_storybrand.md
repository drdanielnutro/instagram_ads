# Revisão do Plano de Fallback — Storybrand

## 1. Sumário Executivo
- O plano reforça corretamente a necessidade de acionar o fallback com base no limiar configurável de qualidade do StoryBrand e de manter o contrato de estado usado pelos agentes atuais, mas utiliza chaves inexistentes (`storybrand_completeness_score`) e ignora componentes já presentes no pipeline (`PlanningOrRunSynth`).【F:aprimoramento_plano_storybrand_v2.md†L6-L25】【F:app/config.py†L34-L71】【F:app/agent.py†L626-L745】【F:app/callbacks/landing_page_callbacks.py†L108-L155】
- Há inconsistências estruturais importantes: diretórios sugeridos não existem, o fallback refere-se a chaves de estado ausentes (`landing_page_analysis`) e a divisão em 16 seções não mapeia diretamente para o schema `StoryBrandAnalysis` (7 elementos), o que inviabiliza a compilação prometida sem detalhamento adicional.【F:aprimoramento_plano_storybrand_v2.md†L27-L80】【de2560†L1-L4】【F:app/callbacks/landing_page_callbacks.py†L108-L155】【F:app/schemas/storybrand.py†L82-L176】
- Para tornar o plano executável, é necessário corrigir as referências de estado, alinhar o gate com o mecanismo já existente de bypass de planejamento e esclarecer como as 16 seções serão agregadas ao schema atual antes de criar os novos agentes/pastas propostos.【F:aprimoramento_plano_storybrand_v2.md†L12-L80】【F:app/agent.py†L264-L280】【F:app/schemas/storybrand.py†L82-L176】

## 2. Itens Corretos e Consistentes
- **Uso do limiar centralizado em `config.min_storybrand_completeness` para acionar o fallback** — O plano propõe ler o limiar diretamente da configuração, o que mantém o comportamento consistente com o valor já exposto por `DevelopmentConfiguration` e passível de override por variável de ambiente.【F:aprimoramento_plano_storybrand_v2.md†L14-L25】【F:app/config.py†L34-L71】  
  - Evidências no código: `DevelopmentConfiguration.min_storybrand_completeness` já está definido e acessível pelo módulo `config` usado pelos agentes.【F:app/config.py†L34-L71】
- **Contrato de estado alinhado com o consumo atual do pipeline** — Garantir que o fallback escreva `storybrand_analysis`, `storybrand_summary` e `storybrand_ad_context` preserva a compatibilidade com agentes como `context_synthesizer`, que espera esses campos antes de planejar os anúncios.【F:aprimoramento_plano_storybrand_v2.md†L7-L8】【F:aprimoramento_plano_storybrand_v2.md†L75-L80】【F:app/agent.py†L697-L745】【F:app/callbacks/landing_page_callbacks.py†L108-L155】
- **Posicionar a decisão de fallback após `landing_page_analyzer`** — Inserir o gate logo depois da análise da landing page é coerente com o fluxo atual do `complete_pipeline`, onde as etapas subsequentes dependem dos dados StoryBrand já carregados no estado.【F:aprimoramento_plano_storybrand_v2.md†L10-L24】【F:app/agent.py†L1221-L1229】【F:app/agent.py†L626-L688】

## 3. Inconsistências Encontradas
- **Referência a `storybrand_completeness_score`** — O plano manda ler `state['storybrand_completeness_score']`, mas o callback grava `analysis.model_dump()` em `storybrand_analysis` (que contém `completeness_score`) e inclui `storybrand_completeness` dentro de `landing_page_context`; não existe a chave citada.【F:aprimoramento_plano_storybrand_v2.md†L20-L25】【F:app/callbacks/landing_page_callbacks.py†L108-L155】【F:app/agent.py†L662-L678】  
  - Impacto: o gate nunca encontraria o score e acionaria o fallback sempre.  
  - Relação com ADK: o `InvocationContext` só expõe o `session.state`; se a chave não existir, o roteamento falha.  
  - **Correção Sugerida**: ler `score = ctx.session.state.get('storybrand_analysis', {}).get('completeness_score')` e, em fallback, usar `landing_page_context.get('storybrand_completeness')` como reserva.
- **Ignorar `PlanningOrRunSynth`** — O plano instrui o gate a chamar diretamente `planning_pipeline`, mas hoje quem decide entre rodar só o sintetizador ou o planejamento completo é o agente `PlanningOrRunSynth` dentro do `complete_pipeline`. Remover ou contornar esse agente quebra o modo "fixed plan" já suportado.【F:aprimoramento_plano_storybrand_v2.md†L12-L24】【F:app/agent.py†L264-L280】【F:app/agent.py†L1221-L1229】  
  - Impacto: sessões que chegam com `planning_mode="fixed"` perderiam a otimização e rodariam o pipeline errado.  
  - Relação com ADK: o gate deve orquestrar agentes (`BaseAgent.run_async`) respeitando a composição existente.  
  - **Correção Sugerida**: receber `planning_or_synth_agent` (instância de `PlanningOrRunSynth`) e invocá-lo no caminho feliz, mantendo o comportamento atual.
- **Estrutura de diretórios inexistente (`app/agents/…`)** — O plano sugere criar arquivos em `app/agents/…`, mas o projeto não tem esse pacote; todos os agentes residem hoje em `app/agent.py` e submódulos (`callbacks`, `tools`).【F:aprimoramento_plano_storybrand_v2.md†L17-L35】【de2560†L1-L4】  
  - Impacto: import errors até que o pacote seja criado e registrado.  
  - **Correção Sugerida**: ou criar explicitamente o pacote `app/agents/__init__.py` e ajustar imports, ou planejar as classes dentro de módulos existentes (ex.: `app/agent.py` ou `app/plan_models`).
- **Uso de `state['landing_page_analysis']`** — O coletor de inputs de fallback deveria ler o contexto salvo em `landing_page_context`; a chave mencionada não é produzida em nenhuma etapa do pipeline atual.【F:aprimoramento_plano_storybrand_v2.md†L31-L35】【F:app/agent.py†L662-L678】  
  - Impacto: os campos obrigatórios do fallback ficariam vazios mesmo quando a análise da landing page trouxe dados suficientes.  
  - **Correção Sugerida**: acessar `state['landing_page_context']` e derivar os campos a partir dele.
- **Mapa de 16 seções → `StoryBrandAnalysis`** — O plano lista 16 seções (incluindo `identity`, `exposition_1/2`, `inciting_incident_*`) mas espera recompilar para os 7 elementos + metadata definidos no schema `StoryBrandAnalysis`. Falta a definição de como essas seções se convertem em `character`, `problem`, `guide`, etc.【F:aprimoramento_plano_storybrand_v2.md†L37-L69】【F:app/schemas/storybrand.py†L82-L176】  
  - Impacto: o compilador não saberá preencher os campos obrigatórios do schema e falhará na validação Pydantic.  
  - **Correção Sugerida**: documentar o mapeamento explícito de cada seção para os atributos do schema (ex.: `exposition_1` → `character.description`, `problem_external` → `problem.types.external`, etc.).
- **Definir `state['storybrand_completeness'] = 1.0` como garantia** — Atualmente, esse campo só existe dentro de `landing_page_context`; nenhum agente lê uma chave de topo com esse nome. Ajustar apenas o estado não evitará reentradas do fallback se a lógica continuar olhando para `storybrand_analysis`/`landing_page_context`.【F:aprimoramento_plano_storybrand_v2.md†L75-L80】【F:app/agent.py†L662-L678】  
  - Impacto: falsa sensação de proteção contra loops; o gate continuaria a usar o score errado.  
  - **Correção Sugerida**: atualizar o score diretamente no objeto `storybrand_analysis` recompilado e, opcionalmente, sobrescrever `landing_page_context['storybrand_completeness']`.
- **Novos campos de entrada no frontend/back-end sem ajustes completos** — O `UserInputExtractor` e o wizard do frontend não conhecem `nome_empresa`, `o_que_a_empresa_faz` ou `sexo_cliente_alvo`; adicioná-los requer expandir `WIZARD_INITIAL_STATE`, validações e a estrutura retornada pelo extractor, além de decidir o conjunto de valores aceitos para sexo/gênero.【F:aprimoramento_plano_storybrand_v2.md†L71-L73】【F:helpers/user_extract_data.py†L5-L200】【F:frontend/src/constants/wizard.constants.ts†L12-L161】  
  - Impacto: sem essas alterações coordenadas, o fallback nunca receberá os dados extras prometidos.  
  - **Correção Sugerida**: detalhar como o wizard armazenará os novos campos (estado inicial, validação, submissão) e como o extractor retornará as chaves adicionais no JSON.
- **Checklist e documentação em diretórios não existentes** — O plano pede `checklists/storybrand_fallback.md`, mas hoje só existe `checklist.md` na raiz; criar um diretório novo pode afetar fluxos de referência existentes (ex.: instruções no AGENTS.md).【F:aprimoramento_plano_storybrand_v2.md†L105-L109】【F:AGENTS.md†L33-L44】  
  - Impacto: referências no fluxo de trabalho atual (`checklist.md`) ficariam inconsistentes.  
  - **Correção Sugerida**: alinhar com o processo descrito em `AGENTS.md`, atualizando a checklist existente ou documentando como o novo arquivo será integrado ao fluxo "Checklist Primeiro, Código Depois".

## 4. Pontos de Incerteza
- Como as 16 seções propostas se alinham exatamente com os atributos do `StoryBrandAnalysis` (quais campos alimentam `guide.authority`, `plan.steps`, etc.).【F:aprimoramento_plano_storybrand_v2.md†L37-L69】【F:app/schemas/storybrand.py†L82-L176】
- Qual vocabulário/controlado será aceito para `sexo_cliente_alvo` e se há implicações de personalização de prompts além de masculino/feminino (ex.: opções não binárias) para o revisor.【F:aprimoramento_plano_storybrand_v2.md†L31-L35】【F:aprimoramento_plano_storybrand_v2.md†L61-L68】
- Se haverá necessidade de armazenar versões anteriores do StoryBrand extraído para comparação quando o fallback sobrescrever `storybrand_analysis` (possível requisito de auditoria não mencionado).【F:aprimoramento_plano_storybrand_v2.md†L88-L92】【F:app/callbacks/landing_page_callbacks.py†L108-L155】

## 5. Viabilidade de Implementação (por tema)
- **Seção 1 — Objetivos e Princípios**: Viável após corrigir a chave do score; o limiar e o contrato de estado já existem. Falta apenas ajustar nomenclatura e definir claramente quais campos o fallback precisa preencher.【F:aprimoramento_plano_storybrand_v2.md†L4-L16】【F:app/callbacks/landing_page_callbacks.py†L108-L155】
- **Seção 2 — Pontos de Integração no `agent.py`**: Parcialmente viável. É preciso reusar `PlanningOrRunSynth` em vez de `planning_pipeline` direto e preparar o novo agente no mesmo módulo ou introduzir um pacote consistente.【F:aprimoramento_plano_storybrand_v2.md†L10-L14】【F:app/agent.py†L264-L280】【F:app/agent.py†L1221-L1229】
- **Seção 3 — StoryBrandQualityGate**: Viável após corrigir a leitura do score e a escrita de métricas; requer também decidir onde o arquivo viverá (novo pacote ou módulo existente).【F:aprimoramento_plano_storybrand_v2.md†L17-L25】【F:app/callbacks/landing_page_callbacks.py†L108-L155】
- **Seção 4 — Fallback StoryBrand Pipeline**: Viabilidade baixa até que o plano detalhe as chaves corretas do estado e o mapeamento para o schema final; também é necessário definir a estrutura de diretórios para os agentes novos.【F:aprimoramento_plano_storybrand_v2.md†L27-L36】【F:app/schemas/storybrand.py†L82-L176】【de2560†L1-L4】
- **Seção 5 — Configuração das Seções**: Depende do item anterior; sem o mapeamento 16→7, o compilador não é implementável. Necessário documentar a correspondência e preparar prompts condizentes.【F:aprimoramento_plano_storybrand_v2.md†L37-L50】【F:app/schemas/storybrand.py†L82-L176】
- **Seção 6 — Loop de Revisão Compartilhado**: Viável, pois `LoopAgent` já é usado no projeto; basta definir prompts e callbacks corretos para `grade`/`comment`. Falta especificar onde os estados intermediários serão armazenados.【F:aprimoramento_plano_storybrand_v2.md†L52-L59】【F:app/agent.py†L1133-L1219】
- **Seção 7 — Prompts Necessários**: Viável desde que o diretório seja criado e versionado; precisa garantir consistência com a convenção de caminhos e explicar como serão carregados (provavelmente via leitura de arquivo em cada agente).【F:aprimoramento_plano_storybrand_v2.md†L61-L69】
- **Seção 8 — Coleta de Inputs Essenciais**: Requer trabalho coordenado em backend e frontend; viável após definir novas estruturas de dados, validações e atualizações de schema. Falta especificar como os dados opcionais chegam ao ADK se o usuário não preencher nada.【F:aprimoramento_plano_storybrand_v2.md†L70-L73】【F:helpers/user_extract_data.py†L5-L200】【F:frontend/src/constants/wizard.constants.ts†L12-L161】
- **Seção 9 — Contrato de Estado Pós-Fallback**: Viável se o compilador devolver um `StoryBrandAnalysis` válido; depende de resolver o mapeamento das seções e de atualizar os campos corretos (`storybrand_analysis` + `landing_page_context`).【F:aprimoramento_plano_storybrand_v2.md†L75-L80】【F:app/schemas/storybrand.py†L82-L176】【F:app/agent.py†L662-L678】
- **Seção 10 — Ajustes em `app/config.py`**: Simples de executar, mas deve ser sincronizado com variáveis de ambiente/documentação e usado pelos novos agentes; nenhuma barreira técnica identificada.【F:aprimoramento_plano_storybrand_v2.md†L82-L86】【F:app/config.py†L34-L71】
- **Seção 11 — Logs e Observabilidade**: Viável; o pipeline já usa logging estruturado. Falta especificar o formato esperado em `state['storybrand_gate_metrics']` e `state['storybrand_audit_trail']` para facilitar análise posterior.【F:aprimoramento_plano_storybrand_v2.md†L88-L92】【F:app/callbacks/landing_page_callbacks.py†L41-L155】
- **Seção 12 — Testes e Validação**: Viável após corrigir a chave do score e definir fixtures para os novos agentes. Falta planejar como mockar os `LlmAgent` utilizados no fallback completo.【F:aprimoramento_plano_storybrand_v2.md†L94-L103】
- **Seção 13 — Documentação**: Viável, mas precisa alinhar com o fluxo de `AGENTS.md` e com a ausência atual de diretórios `checklists/` e `docs/storybrand_fallback.md`; requer decidir onde a nova documentação viverá.【F:aprimoramento_plano_storybrand_v2.md†L105-L109】【F:AGENTS.md†L33-L44】
- **Seção 14 — Feature Flag**: Viável; adicionar `ENABLE_STORYBRAND_FALLBACK` em `config` e condicionar a inclusão do gate no pipeline é compatível com o padrão já usado para outras flags.【F:aprimoramento_plano_storybrand_v2.md†L111-L113】【F:app/config.py†L34-L71】【F:app/agent.py†L1221-L1229】
- **Seção 15 — Etapas Futuras**: São ideias plausíveis, mas dependem das métricas e dados que ainda precisam ser definidos nas seções de observabilidade e contrato de estado. Falta planejar onde armazenar o cache sugerido e como versionar o audit trail.【F:aprimoramento_plano_storybrand_v2.md†L115-L118】【F:app/callbacks/landing_page_callbacks.py†L108-L155】
