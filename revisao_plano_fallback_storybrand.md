# Revisão do Plano de Fallback — Storybrand

## 1. Sumário Executivo
- A proposta de inserir o `StoryBrandQualityGate` logo após o `landing_page_analyzer`, reutilizando o limiar global, está alinhada com o desenho atual do pipeline e preserva o fluxo feliz existente.【F:aprimoramento_plano_storybrand_v2.md†L10-L27】【F:app/agent.py†L1221-L1228】【F:app/config.py†L34-L56】
- Duas lacunas críticas exigem correção no plano: o uso de atributos inexistentes (`config.ENABLE_*`) e a possibilidade de forçar o fallback mesmo quando os novos campos não estão habilitados, situação em que o estado não fornece os dados obrigatórios.【F:aprimoramento_plano_storybrand_v2.md†L22-L27】【F:app/config.py†L34-L94】【F:app/server.py†L221-L304】
- Para viabilizar o gatilho forçado (`force_storybrand_fallback`), o plano precisa instruir explicitamente a propagação dessa flag via `/run_preflight`; do contrário, o dado nunca alcançará o ADK e o fallback não poderá ser acionado manualmente.【F:aprimoramento_plano_storybrand_v2.md†L51-L56】【F:app/server.py†L282-L308】【F:helpers/user_extract_data.py†L420-L567】

## 2. Itens Corretos e Consistentes
- **Gate posicionado após a análise da landing page e reutilizando o limiar existente** — O plano indica que o `StoryBrandQualityGate` deve ser inserido imediatamente depois do `landing_page_analyzer`, usando `config.min_storybrand_completeness`. A sequência atual do `complete_pipeline` e a configuração centralizada confirmam que essa integração é compatível e evita divergências entre caminhos.【F:aprimoramento_plano_storybrand_v2.md†L10-L27】【F:app/agent.py†L1221-L1228】【F:app/config.py†L34-L56】  
  - Evidências no código: `complete_pipeline` já encadeia `landing_page_analyzer` → `PlanningOrRunSynth`; `DevelopmentConfiguration` expõe `min_storybrand_completeness`.
- **Compilação 16→7 reaproveita implementação existente** — As regras descritas para consolidar as 16 seções em `StoryBrandAnalysis` correspondem exatamente ao que `FallbackStorybrandCompiler` já faz, incluindo cálculo de `metadata.text_length` e sincronização do score para 1.0, permitindo reutilizar o módulo atual sem alterações estruturais.【F:aprimoramento_plano_storybrand_v2.md†L29-L38】【F:app/agents/fallback_compiler.py†L210-L233】  
  - Evidências no código: o compilador escreve `storybrand_analysis`, `storybrand_summary`, `storybrand_ad_context` e ajusta `landing_page_context['storybrand_completeness']`.
- **Pré-condições de entrada alinhadas entre backend, frontend e checklist** — Quando as flags de novos campos estão ativas, o wizard força o preenchimento de `nome_empresa`, `o_que_a_empresa_faz` e `sexo_cliente_alvo`; o helper valida a transformação (mínimo de 30 caracteres, verbo de ação e gênero binário), e o checklist marca esses passos como concluídos, garantindo que o fallback receba insumos consistentes.【F:aprimoramento_plano_storybrand_v2.md†L51-L55】【F:helpers/user_extract_data.py†L420-L559】【F:frontend/src/constants/wizard.constants.ts†L15-L135】【F:checklist.md†L40-L43】  
  - Evidências no código: validações de formulário no frontend; `_is_transformational_description` e rejeição de `sexo_cliente_alvo` inválido no preflight.

## 3. Inconsistências Encontradas
- **Atributos inexistentes em `config` (`config.ENABLE_*`)** — O plano orienta o gate a ler `config.ENABLE_STORYBRAND_FALLBACK` e `config.ENABLE_NEW_INPUT_FIELDS`, mas a configuração expõe apenas atributos em `snake_case` (`enable_storybrand_fallback` ainda será adicionado, `enable_new_input_fields` já existe). Usar o nome incorreto gerará `AttributeError` e impedirá o roteamento do pipeline.【F:aprimoramento_plano_storybrand_v2.md†L22-L27】【F:app/config.py†L34-L94】
  - Impacto: quebra imediata na execução do gate ao tentar acessar atributos inexistentes.
  - Evidências no código: `DevelopmentConfiguration` define apenas atributos em minúsculas e as variáveis de ambiente fazem override sobre esses nomes.
  - Relação com ADK: o `BaseAgent` falharia antes de decidir o caminho, bloqueando todo o fluxo multiagente.
  - **Correção Sugerida**: atualizar o plano para citar `config.enable_storybrand_fallback` e `config.enable_new_input_fields`, deixando explícitas as variáveis de ambiente `ENABLE_STORYBRAND_FALLBACK` e `ENABLE_NEW_INPUT_FIELDS` para os overrides. Incluir na seção operacional o passo de revisar os trechos "Como fazer" para garantir que todo acesso a flags siga a convenção `snake_case`.
- **Forçar fallback sem novos campos habilitados deixa o estado inconsistente** — A mesma seção indica que, se `state['force_storybrand_fallback']` ou `config.storybrand_gate_debug` estiverem ativos, o gate deve invocar o fallback imediatamente. Porém, quando `config.enable_new_input_fields` é `False` (valor padrão), o `/run_preflight` não inclui `nome_empresa`, `o_que_a_empresa_faz` nem `sexo_cliente_alvo` no `initial_state`, inviabilizando os requisitos mínimos descritos para o pipeline de recuperação.【F:aprimoramento_plano_storybrand_v2.md†L22-L27】【F:app/server.py†L221-L304】【F:app/config.py†L34-L56】  
  - Impacto: o fallback iniciaria sem os campos obrigatórios, provocando abortos prematuros ou textos genéricos inconsistentes.  
  - Evidências no código: `initial_state` só recebe os novos campos quando `config.enable_new_input_fields` é verdadeiro.  
  - Relação com ADK: os sub-agentes dependerão de `ctx.session.state['nome_empresa']` etc.; sem essas chaves, os loops de escrita/revisão falharão.  
  - **Correção Sugerida**: deixar explícito que mesmo o fallback forçado depende de `config.enable_new_input_fields=True` (e da flag frontend correspondente) ou, alternativamente, instruir o plano a preencher esses campos antes de acionar o pipeline quando a flag estiver desativada. Acrescentar no roteiro de rollout um checklist de validação das flags antes de permitir a operação manual.
- **Flag `force_storybrand_fallback` não chega ao ADK** — O plano prevê que o preflight sete `state['force_storybrand_fallback']`, mas o endpoint `/run_preflight` não propaga esse dado ao construir o `initial_state`, nem o helper atual retorna esse campo. Assim, o gate nunca enxergará a flag, tornando o mecanismo de força inexequível.【F:aprimoramento_plano_storybrand_v2.md†L51-L56】【F:app/server.py†L282-L308】【F:helpers/user_extract_data.py†L420-L567】  
  - Impacto: mesmo configurando a flag, o estado da sessão não refletirá a intenção de forçar o fallback; o fluxo permanecerá preso ao caminho feliz.  
  - Evidências no código: `initial_state` copia apenas chaves explícitas (`landing_page_url`, `objetivo_final`, novos campos quando habilitados) e o helper não produz `force_storybrand_fallback`.  
  - Relação com ADK: sem a flag disponível em `ctx.session.state`, o `StoryBrandQualityGate` não terá gatilho manual.  
  - **Correção Sugerida**: incluir no plano a atualização do `/run_preflight` (e, se necessário, do helper) para preencher `initial_state['force_storybrand_fallback']` quando configurado. Detalhar no plano quem adicionará o campo ao `UserExtractedData` e aos testes correspondentes, garantindo a cobertura E2E.

## 4. Plano de Correção das Inconsistências
- **Atualização das referências às flags** — Revisar a Seção 2 do plano para substituir todos os acessos `config.ENABLE_*` por `config.enable_*`, documentando as variáveis de ambiente correspondentes e indicando a necessidade de testes unitários no `StoryBrandQualityGate` para cobrir o acesso correto.【F:aprimoramento_plano_storybrand_v2.md†L22-L27】【F:app/config.py†L34-L94】
- **Rollout coordenado das flags de novos campos** — Inserir na Seção 3 um subtópico que condicione o fallback forçado ao enablement simultâneo de `config.enable_new_input_fields` e `VITE_ENABLE_NEW_FIELDS`, com passo de verificação no checklist antes de acionar o fallback.【F:aprimoramento_plano_storybrand_v2.md†L22-L27】【F:app/server.py†L221-L304】【F:frontend/src/constants/wizard.constants.ts†L42-L135】
- **Propagação da flag `force_storybrand_fallback`** — Complementar as Seções 4 e 5 instruindo explicitamente a alterar `/run_preflight` e `helpers/user_extract_data.py` para incluir a flag no `initial_state`, atualizar o contrato de dados e criar testes que validem a presença da chave no estado inicial do ADK.【F:aprimoramento_plano_storybrand_v2.md†L51-L56】【F:app/server.py†L282-L308】【F:helpers/user_extract_data.py†L420-L567】

## 5. Pontos de Incerteza
- Não está claro como o `fallback_quality_reporter` será consumido depois do pipeline — logs no estado bastam ou será necessário persistir em storage externo?【F:aprimoramento_plano_storybrand_v2.md†L40-L50】
- O plano não define como proceder quando backend e frontend estiverem com flags desencontradas (`ENABLE_NEW_INPUT_FIELDS` vs. `VITE_ENABLE_NEW_FIELDS`), cenário ainda possível durante rollout gradual.【F:aprimoramento_plano_storybrand_v2.md†L51-L55】【F:app/server.py†L221-L304】
- Falta detalhamento sobre quem manterá os prompts sincronizados entre `prompts/storybrand_fallback/` e os modelos existentes (`storybrand_*.txt`), especialmente considerando versões em produção.【F:aprimoramento_plano_storybrand_v2.md†L60-L78】

## 6. Viabilidade de Implementação (por tema)
- **Seções 2–3 (gate e thresholds)** — Viável: o pipeline e a configuração atual já expõem os pontos de integração necessários; basta implementar o agente customizado e ajustar o acesso correto às flags.【F:aprimoramento_plano_storybrand_v2.md†L10-L27】【F:app/agent.py†L1221-L1228】【F:app/config.py†L34-L56】
- **Seção 4 (pipeline de fallback)** — Exequível, desde que as flags dos novos campos estejam ativas; caso contrário, é preciso alinhar o plano às correções indicadas para evitar execução sem insumos obrigatórios.【F:aprimoramento_plano_storybrand_v2.md†L40-L56】【F:app/server.py†L221-L304】
- **Seções 7 e 16 (prompts e contratos de dados)** — Implementáveis, mas exigem a criação do `PromptLoader` e disciplina de manutenção dos arquivos; não há impedimentos técnicos no código atual.【F:aprimoramento_plano_storybrand_v2.md†L60-L194】
- **Seção 8 (coleta de inputs essenciais)** — Viável apenas com rollout coordenado das flags no backend (`config.enable_new_input_fields`) e frontend (`VITE_ENABLE_NEW_FIELDS`); sem isso, os campos não estarão disponíveis para o fallback.【F:aprimoramento_plano_storybrand_v2.md†L51-L55】【F:helpers/user_extract_data.py†L420-L559】【F:frontend/src/constants/wizard.constants.ts†L42-L135】
- **Seções 11–13 (observabilidade, testes e documentação)** — Demandam trabalho adicional, porém podem ser atendidas com os mecanismos de logging já existentes e com a ampliação do checklist; nenhuma limitação estrutural foi encontrada.【F:aprimoramento_plano_storybrand_v2.md†L111-L138】【F:checklist.md†L6-L81】
