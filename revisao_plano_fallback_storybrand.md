# Revisão do Plano de Fallback — Storybrand

## 1. Sumário Executivo
- O posicionamento do `StoryBrandQualityGate` após o `landing_page_analyzer`, reutilizando o `PlanningOrRunSynth` e o limiar já exposto em `config.min_storybrand_completeness`, é coerente com o desenho atual do `complete_pipeline` e evita duplicação de lógica de decisão.【F:aprimoramento_plano_storybrand_v2.md†L10-L27】【F:app/agent.py†L1221-L1228】【F:app/config.py†L34-L57】
- A estratégia de coleta e enriquecimento dos inputs obrigatórios (`nome_empresa`, `o_que_a_empresa_faz`, `sexo_cliente_alvo`) está alinhada com o preflight e com o wizard gated por `VITE_ENABLE_NEW_FIELDS`, garantindo que o fallback tenha dados válidos sempre que as flags forem ativadas.【F:aprimoramento_plano_storybrand_v2.md†L51-L96】【F:helpers/user_extract_data.py†L60-L599】【F:app/server.py†L211-L356】【F:frontend/src/constants/wizard.constants.ts†L15-L273】
- As correções incorporadas ao plano removem a duplicidade da flag `enable_storybrand_fallback` e definem o `PromptLoader` como carregador eager com cache, alinhando o documento ao comportamento desejado pelo código e eliminando ambiguidades operacionais.【F:aprimoramento_plano_storybrand_v2.md†L143-L220】【F:app/config.py†L34-L100】

## 2. Itens Corretos e Consistentes
- **Gate após a análise da landing page** — Inserir o `StoryBrandQualityGate` logo após `landing_page_analyzer`, reutilizando o `PlanningOrRunSynth` existente e o limiar `config.min_storybrand_completeness`, mantém o fluxo feliz intacto e concentra a decisão em um único ponto de controle.【F:aprimoramento_plano_storybrand_v2.md†L10-L27】【F:app/agent.py†L1221-L1228】【F:app/config.py†L34-L57】  
  - Evidências no código: `complete_pipeline` hoje encadeia `landing_page_analyzer` → `PlanningOrRunSynth`; a configuração centraliza o limiar.
- **Compilação 16→7 reutiliza implementação já disponível** — As regras descritas para converter as 16 seções do fallback em `StoryBrandAnalysis` correspondem ao que `FallbackStorybrandCompiler` já executa, incluindo sincronização do score e atualização de `landing_page_context` para 1.0.【F:aprimoramento_plano_storybrand_v2.md†L29-L38】【F:app/agents/fallback_compiler.py†L86-L237】  
  - Evidências no código: o compilador existente lê as mesmas chaves (`storybrand_*`, `exposition_*`) e persiste `storybrand_analysis`, `storybrand_summary` e `storybrand_ad_context` com score 1.0.
- **Pré-condições de dados alinhadas entre preflight, backend e frontend** — O plano exige que o preflight retorne erro quando os três campos essenciais não atingirem os critérios, exatamente como o `UserInputExtractor`, o endpoint `/run_preflight` e o wizard já implementam quando as flags estão ativadas.【F:aprimoramento_plano_storybrand_v2.md†L51-L96】【F:helpers/user_extract_data.py†L423-L599】【F:app/server.py†L205-L356】【F:frontend/src/constants/wizard.constants.ts†L15-L273】  
  - Evidências no código: validações de transformação no helper, bloqueio HTTP 422 no preflight e passos condicionais do wizard confirmam o contrato descrito.
- **Checklist espelha os entregáveis do plano** — As tarefas pendentes listadas no `checklist.md` cobrem exatamente os módulos novos (gate, pipeline sequencial, PromptLoader, testes, documentação), reforçando a viabilidade operacional das etapas propostas.【F:aprimoramento_plano_storybrand_v2.md†L40-L218】【F:checklist.md†L1-L78】

## 3. Inconsistências Encontradas
- Nenhuma inconsistência remanescente após as correções aplicadas ao plano. A Seção 14 passou a orientar a reutilização da flag existente, e a Seção 16.4 descreve explicitamente o carregamento eager do `PromptLoader`, atendendo às recomendações anteriores.【F:aprimoramento_plano_storybrand_v2.md†L143-L220】

## 4. Pontos de Incerteza
- A seção 3 não esclarece se `config.storybrand_gate_debug` deve ignorar as flags `enable_storybrand_fallback`/`enable_new_input_fields` ao forçar o fallback. O texto primeiro condiciona toda execução às duas flags estarem `True`, mas logo depois indica que o debug força a rota de recuperação — é necessário definir qual regra prevalece.【F:aprimoramento_plano_storybrand_v2.md†L22-L27】
- Não há definição sobre quem garantirá a sincronia dos prompts entre o novo diretório `prompts/storybrand_fallback/` e versões de produção, inclusive quanto a revisões linguísticas e governança. O plano cita a necessidade de manter “ambos os planos sincronizados”, mas não atribui responsabilidade operacional.【F:aprimoramento_plano_storybrand_v2.md†L60-L111】

## 5. Viabilidade de Implementação (por tema)
- **Integração do gate no `complete_pipeline` (Seções 2–3)** — Viável. O pipeline atual expõe um ponto único após `landing_page_analyzer`, e o `PlanningOrRunSynth` pode ser passado como dependência, bastando criar o novo agente e condicionar sua inclusão à flag existente.【F:aprimoramento_plano_storybrand_v2.md†L10-L27】【F:app/agent.py†L1221-L1228】【F:app/config.py†L34-L57】
- **Pipeline de fallback e compilador (Seção 4)** — Exequível. O compilador já implementa o contrato 16→7 e o checklist mapeia as etapas restantes (initializer, collector, loops). A execução depende apenas da criação dos novos agentes e do diretório de prompts previsto.【F:aprimoramento_plano_storybrand_v2.md†L38-L111】【F:app/agents/fallback_compiler.py†L86-L237】【F:checklist.md†L19-L38】
- **Coleta/enriquecimento de inputs (Seções 8–9)** — Implementação sustentada pelo código atual: preflight e frontend validam os campos quando as flags são ativadas, e o servidor propaga `force_storybrand_fallback` apenas nesse contexto, garantindo estado consistente para o fallback.【F:aprimoramento_plano_storybrand_v2.md†L51-L107】【F:helpers/user_extract_data.py†L423-L599】【F:app/server.py†L205-L356】【F:frontend/src/constants/wizard.constants.ts†L15-L273】
- **Prompts e utilitário `PromptLoader` (Seção 16.4)** — Viável. O plano agora determina carregamento eager com cache, validando a presença de todos os arquivos na inicialização antes de servir as strings renderizadas, o que reduz riscos de runtime e mantém o alinhamento com o checklist.【F:aprimoramento_plano_storybrand_v2.md†L60-L220】【F:checklist.md†L35-L38】
