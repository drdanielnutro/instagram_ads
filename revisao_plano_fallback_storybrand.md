# Revisão do Plano de Fallback — Storybrand

## 1. Sumário Executivo
- O posicionamento do `StoryBrandQualityGate` logo após o `landing_page_analyzer`, reutilizando o limiar centralizado em `config.min_storybrand_completeness`, está em linha com o pipeline atual e mantém o contrato de estado usado pelo fluxo "feliz".【F:aprimoramento_plano_storybrand_v2.md†L10-L24】【F:app/config.py†L48-L71】【F:app/agent.py†L1221-L1229】
- O mapeamento 16→7 planejado para o compilador já está coberto pela implementação existente em `FallbackStorybrandCompiler`, garantindo consistência entre caminhos normal e fallback.【F:aprimoramento_plano_storybrand_v2.md†L27-L36】【F:app/agents/fallback_compiler.py†L89-L237】
- Risco principal: o plano prevê que o `fallback_input_collector` recupere `nome_empresa`, `o_que_a_empresa_faz` e `sexo_cliente_alvo` a partir de `landing_page_context`, mas o estado atual grava esses campos na raiz da sessão; seguir o plano literal deixaria o fallback sem entradas obrigatórias.【F:aprimoramento_plano_storybrand_v2.md†L42-L46】【F:app/agent.py†L626-L687】【F:app/server.py†L284-L305】
- Outro ponto crítico: exigir abortar quando `sexo_cliente_alvo` não for `masculino|feminino` conflita com o valor padrão `neutro` produzido quando os novos campos não estão habilitados; é preciso acoplar o fallback às mesmas flags que tornam os campos obrigatórios ou tratar esse caso explicitamente.【F:aprimoramento_plano_storybrand_v2.md†L176-L184】【F:app/server.py†L220-L305】【F:helpers/user_extract_data.py†L300-L420】

## 2. Itens Corretos e Consistentes
- **Gate reutiliza `config.min_storybrand_completeness` e a posição após o analisador** — O plano orienta injetar o gate no `complete_pipeline` logo depois do `landing_page_analyzer` e ler o limiar da configuração global. Isso preserva o fluxo existente que hoje aciona `PlanningOrRunSynth` e já usa o mesmo parâmetro de qualidade.【F:aprimoramento_plano_storybrand_v2.md†L10-L24】【F:app/config.py†L48-L71】【F:app/agent.py†L1221-L1229】
  - Evidências no código: `DevelopmentConfiguration.min_storybrand_completeness`; `complete_pipeline` instancia `PlanningOrRunSynth` após o analisador.
- **Contrato de estado compartilhado entre caminhos feliz e fallback** — A exigência de manter `storybrand_analysis`, `storybrand_summary` e `storybrand_ad_context` em ambos os caminhos já está atendida: o callback da análise grava essas chaves e o compilador fallback as repõe com dados válidos.【F:aprimoramento_plano_storybrand_v2.md†L4-L9】【F:aprimoramento_plano_storybrand_v2.md†L88-L97】【F:app/callbacks/landing_page_callbacks.py†L111-L129】【F:app/agents/fallback_compiler.py†L222-L237】
  - Evidências no código: persistência das três chaves e sincronização do score com `landing_page_context`.
- **Mapeamento 16→7 já compatível** — As regras descritas (agregar exposições no problema, priorizar `value_proposition` no guia, dividir CTAs, etc.) espelham exatamente o que `FallbackStorybrandCompiler` já faz, evitando retrabalho e garantindo aderência ao schema Pydantic atual.【F:aprimoramento_plano_storybrand_v2.md†L27-L36】【F:app/agents/fallback_compiler.py†L89-L237】
  - Evidências no código: composição dos elementos, cálculo de `metadata.text_length`, atualização de `completeness_score` para 1.0.
- **Pré-condições para inputs essenciais alinhadas ao frontend/backend** — O plano condiciona o fallback a receber `nome_empresa`, `o_que_a_empresa_faz` e `sexo_cliente_alvo` validados. Tanto o extractor quanto o wizard já tratam esses campos e o checklist marca as ações como concluídas, tornando a etapa viável quando as flags estiverem ativas.【F:aprimoramento_plano_storybrand_v2.md†L80-L87】【F:helpers/user_extract_data.py†L60-L420】【F:frontend/src/constants/wizard.constants.ts†L15-L273】【F:checklist.md†L40-L43】
  - Evidências no código: prompts e validações no extractor; passos obrigatórios no wizard quando `VITE_ENABLE_NEW_FIELDS=true`.
- **Adoção do checklist central da raiz** — O plano remete ao checklist principal e ele já enumera as etapas esperadas do fallback, garantindo governança do progresso sem exigir um artefato paralelo.【F:aprimoramento_plano_storybrand_v2.md†L116-L120】【F:checklist.md†L1-L81】
  - Evidências: checklist aponta diretamente para tarefas do plano v2.

## 3. Inconsistências Encontradas
- **Coleta dos três inputs essenciais a partir de `landing_page_context`** — O plano define que `fallback_input_collector` preencherá `nome_empresa`, `o_que_a_empresa_faz` e `sexo_cliente_alvo` lendo `state['landing_page_context']`. Contudo, o `landing_page_analyzer` só produz dados narrativos da página (headline, benefícios, CTAs etc.) e nunca inclui esses campos de negócio; eles chegam via `initial_state` da preflight e ficam na raiz do estado quando `ENABLE_NEW_INPUT_FIELDS` está ativo.【F:aprimoramento_plano_storybrand_v2.md†L42-L46】【F:app/agent.py†L626-L687】【F:app/server.py†L284-L305】
  - Impacto: o coletor ficaria sem valores válidos e, por consequência, o fallback abortaria mesmo com dados fornecidos pelo usuário.
  - Evidências no código: estrutura de `landing_page_context`; inicialização dos campos na raiz do estado.
  - Relação com ADK: o `SequentialAgent` do fallback operará sobre `ctx.session.state`; ler a chave errada impede cumprir o contrato de dados.
  - **Correção Sugerida**: alterar o requisito do plano para que o coletor leia primeiro as chaves de topo (`state['nome_empresa']`, `state['o_que_a_empresa_faz']`, `state['sexo_cliente_alvo']`), usando `landing_page_context` apenas como fonte suplementar se forem adicionados lá no futuro.

- **Abortar quando `sexo_cliente_alvo` ≠ {masculino,feminino} sem sincronizar flags** — A Seção 16.3 determina falha imediata para valores fora do domínio binário. Entretanto, quando `ENABLE_NEW_INPUT_FIELDS` está desativado (configuração padrão) o backend mantém `sexo_cliente_alvo='neutro'`, e o extractor só aplica validações rígidas quando a flag está habilitada; em shadow mode ele deixa o campo vazio sem erro.【F:aprimoramento_plano_storybrand_v2.md†L176-L184】【F:app/server.py†L220-L305】【F:helpers/user_extract_data.py†L300-L420】
  - Impacto: ativar o fallback sem alinhar as flags quebraria o fluxo por erro forçado, mesmo em ambientes onde a UI ainda não obriga o preenchimento.
  - Evidências no código: default `neutro` no preflight; validações condicionais no extractor.
  - Relação com ADK: o gate poderia disparar fallback (por score baixo) e a própria recuperação abortaria por inconsistência artificial.
  - **Correção Sugerida**: atualizar o plano para vincular `ENABLE_STORYBRAND_FALLBACK` à ativação das flags de coleta (`ENABLE_NEW_INPUT_FIELDS`/`VITE_ENABLE_NEW_FIELDS`) ou, alternativamente, instruir o coletor a converter `neutro` em um fluxo guiado de seleção antes de abortar.

## 4. Pontos de Incerteza
- Como o pipeline deve se comportar quando `ENABLE_NEW_INPUT_FIELDS` e `VITE_ENABLE_NEW_FIELDS` estiverem dessincronizadas (por exemplo, frontend habilitado e backend não)?【F:aprimoramento_plano_storybrand_v2.md†L80-L87】【F:app/server.py†L220-L305】
- Qual será a fonte de verdade para os prompts (estrutura, placeholders e owners) no diretório `prompts/storybrand_fallback/`, ainda inexistente no repositório?【F:aprimoramento_plano_storybrand_v2.md†L186-L194】
- A responsabilidade do `fallback_quality_reporter` (opcional) inclui persistência em storage externo ou apenas logs no estado? O plano não esclarece consumidores desse relatório.【F:aprimoramento_plano_storybrand_v2.md†L42-L46】

## 5. Viabilidade de Implementação (por tema)
- **Seções 1–3 (Gate e thresholds)** — Viável: o pipeline já expõe `PlanningOrRunSynth` e o limiar centralizado, restando implementar o agente customizado e a métrica conforme o contrato descrito.【F:aprimoramento_plano_storybrand_v2.md†L10-L36】【F:app/config.py†L48-L71】【F:app/agent.py†L1221-L1229】
- **Seção 4 (Pipeline fallback)** — Estruturalmente viável, pois `SequentialAgent` e `LoopAgent` já são usados em outros pontos; contudo, é necessário corrigir a origem dos três inputs obrigatórios antes de implementar o coletor para evitar falhas imediatas.【F:aprimoramento_plano_storybrand_v2.md†L38-L46】【F:app/agent.py†L626-L687】【F:app/server.py†L284-L305】
- **Seções 5–6 (Config das seções e loop compartilhado)** — Exequível: o compilador já espera as 16 chaves e os loops existentes podem servir de referência. Depende da criação dos prompts e do `PromptLoader` proposto.【F:aprimoramento_plano_storybrand_v2.md†L48-L69】【F:app/agents/fallback_compiler.py†L89-L237】
- **Seção 8 (Inputs essenciais)** — Viável apenas quando as flags de novos campos estiverem ativas em frontend e backend; caso contrário, ajustes adicionais são necessários para conciliar com o requisito de abortar em valores inválidos.【F:aprimoramento_plano_storybrand_v2.md†L80-L87】【F:frontend/src/constants/wizard.constants.ts†L15-L273】【F:helpers/user_extract_data.py†L300-L420】【F:app/server.py†L220-L305】
- **Seções 9–13 (Contrato pós-fallback, configuração, observabilidade, testes e documentação)** — Executável com o que já existe: o compilador atual cumpre a maior parte do contrato, `checklist.md` cobre as tarefas e restam adicionar novas flags/configurações e rotinas de logging/testes.【F:aprimoramento_plano_storybrand_v2.md†L88-L121】【F:app/agents/fallback_compiler.py†L222-L237】【F:checklist.md†L1-L81】
- **Seções 14–16 (Feature flag, métricas e contratos)** — Implementável, mas dependente das correções acima: criar as flags em `config`, garantir que `storybrand_gate_metrics` e `storybrand_audit_trail` sejam preenchidos e alinhar a política de `sexo_cliente_alvo` com as condições de produção.【F:aprimoramento_plano_storybrand_v2.md†L122-L194】【F:app/server.py†L220-L305】
